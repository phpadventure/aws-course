provider "aws" {
    region = "us-west-2"
    profile = "default"
}


module "instance_profile" {
  source = "./modules/access"
}

data "template_file" "private_init_script" {
  template = "${file(var.private_init_sh_file)}"

  vars = {
    rds_host = "12313" #"${aws_instance.my-instance-week-2.public_ip}"
  }
}

module "ec2_template_private" {
  source = "./modules/ec2-template"

  instance_ssh_key = var.instance_ssh_key
  template_name = "private"
  user_data = "${base64encode(data.template_file.private_init_script.rendered)}"
  iam_instance_profile_arn = module.instance_profile.profile_arn
}

resource "aws_instance" "private-instance" {
  launch_template {
    id =  module.ec2_template_private.template_id
    version = "$Latest"
  } 
  security_groups = [aws_security_group.my_group_ssh_http.name]
}


resource "aws_security_group" "my_group_ssh_http" {
    description = "Enable HTTP access via port 80 + SSH access"
    name = "security_group_ssh_http"

    ingress {
        description      = "HTTP from VPC"
        from_port        = 80
        to_port          = 80
        protocol         = "tcp"
        cidr_blocks      = ["0.0.0.0/0"]
    }
    ingress {
        description      = "SSH from VPC"
        from_port        = 22
        to_port          = 22
        protocol         = "tcp"
        cidr_blocks      = ["0.0.0.0/0"]
    }

    egress {
        from_port        = 0
        to_port          = 0
        protocol         = "-1"
        cidr_blocks      = ["0.0.0.0/0"]
        ipv6_cidr_blocks = ["::/0"]
    }
}